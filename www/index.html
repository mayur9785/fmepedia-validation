<!doctype html>
<html lang="en">
<meta charset="UTF-8">
<style type="text/css">
	#map_canvas {
		height: 600px;
	}
	dt {
		padding-top:18px;
		padding-bottom: 5px;
	}
</style>
<head>
	<!-- Safe Software, 2013 -->
	<!-- http://www.safe.com -->

	<title>Realtime Display</title>

	<!-- JQuery -->
	<script src="libs/jquery-1.10.1.js"></script>

	<!-- Bootstrap -->
	<!--http://getbootstrap.com/2.3.2/-->
	<script src="libs/bootstrap/js/bootstrap.js"></script>
	<link href="libs/bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="libs/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
  
	<!-- Google Maps -->
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?v=3&sensor=false"></script>

	<!-- Stylesheet for demo/tutorial -->
	<link rel="stylesheet" href="css/index.css">
	
  <!-- Upload Library -->
  <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
  <script src="libs/upload/js/vendor/jquery.ui.widget.js"></script>
  <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  <script src="libs/upload/js/jquery.iframe-transport.js"></script>
  <!-- The basic File Upload plugin -->
  <script src="libs/upload/js/jquery.fileupload.js"></script>
  <!-- The File Upload UI plugin -->
  <link rel="stylesheet" href="libs/upload/css/jquery.fileupload-ui.css">
  
  
	<!-- FME Server Javascript API -->
	<script type="text/javascript" src="http://api.fmeserver.com/js/v1.1/FMEServer.js"></script>
	<script type="text/javascript">
		// Required for FME Server Connection Object and Email
		var fmeserverurl = "fmepedia2014-safe-software.fmecloud.com";
	</script>
  
  <!-- CAD validation demo JS -->
  <script src="./js/cadValidation.js" type="text/javascript"></script>
  
</head>

<body onload="initialize()">

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">        
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>

			<div class="brand">FME Server<span class="hidden-tiny"> Demos</span></div>
				 
			<div class="nav-collapse collapse">
				<a href="https://github.com/safesoftware/fmepedia-validation" class="btn">
					<img src="libs/github.png"> Fork GitHub
				</a>
				<a href="https://github.com/safesoftware/fmepedia-validation/archive/master.zip" class="btn">
					<i class="icon-download-alt"></i> Download Zip
				</a>
			</div>
			<span class="hidden-phone" id="safe-ribbon"><a href="http://www.safe.com">Powered by FME</a></span>
			</div>
		</div>
	</div>

	<div class="container">
	  <div class="row">
		<div class="span12">
			<h1>Realtime Display <small>Upload CAD data and watch it appear in realtime</small></h1>
		</div>
      </div>
      <!-- Content -->
      <div class="row">
        <div class="span4">
			<h3>User manual</h3>
			<dl>
				<dt>1. Prepare database <span id="dbstatus" class="label label-important">Database not ready</span></dt>
				<dd>
					<button class="btn btn-primary" onclick="javascript: deleteDb();">Delete data</button>
				</dd>
				<dt>2. Download example data</dt>
				<dd><a target="_blank" href='download/distribution_N25_good.dwg'>distribution_N25_good.dwg</a></dd>
				<dd><a target="_blank" href='download/distribution_N25_bad.dwg'>distribution_N25_bad.dwg</a></dd>
				<dt>3. Send file to FMEServer</dt>
				<dd>
					<p>a. By email:</p>
          <script type="text/javascript">
						document.write('<p><a href="mailto:cad_waterqa@' + fmeserverurl +'" target="_blank"> cad_waterqa@' + fmeserverurl +'</a></p>');
					</script>
          <section>
            <p>b. By direct upload:</p>
            <div id='dropzone' class='fade well well-large'>
              <!-- The container for the uploaded files -->
              <div id='fileTable' style='display:none'></div>


              <p id='dropText'>Drop your files here</p>
              <br/>
              <span class="btn btn-success fileinput-button">
                <i class="icon-plus icon-white"></i>
                <span>Add files...</span>
                <!-- The file input field used as target for the file upload widget -->
                <input id="fileupload" type="file" name="files[]" multiple>
              </span>
            </div>
            <button class='btn btn-medium pull-right' id="submitToServer" onClick="BuildForm.submit()">Submit</button>
          </section>
          <div id="results"></div>
				</dd>
				<dt>4. Wait and see</dt>
				<dd>Number of Features received: <span class="badge" id='numFeat'>0</span></dd>
			</dl>
        </div>
        <div class="span8">
			<div id="map_canvas"></div>
        </div>
      </div>
	</div>
	<script type="text/javascript">
		var polygonArray = [];
		var map, conn;
		var features = 0;

		function initialize() {
			/*** Initialize the map ***/
			var myOptions = {
				center : new google.maps.LatLng(30.302793482150715, -97.65678371362306),
				zoom : 15,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};

			map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);
		};

		// Wait for load
		window.onload = function(){
			
			FMEServer.init({
				server : "https://"+fmeserverurl,
				token : "fb1c3ee6828e6814c75512dd4770a02e73d913b8"
			});
		
			/*** FME Server WebSocket initialization ***/
			conn = FMEServer.getWebSocketConnection("cadqa");
			
			/*** Reacting to incoming messages on WebSocket ***/
			conn.onmessage = function(event) {
			
				var jsonFeature = JSON.parse(event.data);
				features++;
				document.getElementById('numFeat').textContent = features;
				
				// Parse geometry and add to map
				switch(jsonFeature.type) {
					case 'i':

						var polyCoords = [];
						var coords = jsonFeature.features[0].coordinates;

						for(var j = 0; j < coords.length; j++) {

							var lng = coords[j][0];
							var lat = coords[j][1];

							polyCoords.push(new google.maps.LatLng(lat, lng));
						}

						var poly = new google.maps.Polyline({
							path : polyCoords,
							strokeColor : "#FF0000",
							strokeOpacity : 0.8,
							strokeWeight : 2,
							fillColor : "#FF0000",
							fillOpacity : 0.35
						});

						poly.setMap(map);
						polygonArray.push(poly);
						break;
					case 'u':
					
						//remove item from map
						if(polygonArray) {
							for(i in polygonArray) {
								if(parseInt(polyId) === parseInt(polygonArray[i].id)) {
									polygonArray[i].setMap(null);
									polygonArray.splice(i, 1);
								}

							}
						}
						
						var polyCoords = [];
						var coords = jsonFeature.features[0].coordinates[0];

						for(var j = 0; j < coords.length; j++) {

							var lng = coords[j][0];
							var lat = coords[j][1];

							polyCoords.push(new google.maps.LatLng(lat, lng));
						}

						var poly = new google.maps.Polygon({
							paths : polyCoords,
							id : jsonFeature.id,
							strokeColor : "#FF0000",
							strokeOpacity : 0.8,
							strokeWeight : 2,
							fillColor : "#FF0000",
							fillOpacity : 0.35
						});

						poly.setMap(map);
						polygonArray.push(poly);
						break;
					case 'd':
						//remove item from map
						if(polygonArray) {
							for(i in polygonArray) {
								if(parseInt(polyId) === parseInt(polygonArray[i].id)) {
									polygonArray[i].setMap(null);
									polygonArray.splice(i, 1);
								}

							}
						}
						break;
					default:
				}
			}
		};
		
		// This function calls the workspace to reset the database
		function deleteDb() {
			document.getElementById('dbstatus').setAttribute("class","label label-warning");
			document.getElementById('dbstatus').textContent = "Waiting for answer...";
			
			// Object required for submitSyncJob method
			// For this case we are using server default values, but we still need to
			// pass an empty object to the method.
			var params = {};

			FMEServer.submitSyncJob("validation", "reset-postgis-table.fmw", params, function(json){
				document.getElementById('dbstatus').setAttribute("class","label label-success");
				document.getElementById('dbstatus').textContent = "Database ready";
			});
		}

		initialize();
	</script>
</body>

</html>